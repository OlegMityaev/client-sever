\section{Перечень модулей клиентской и серверной частей}

\subsection{Клиентская часть}

Клиентская часть приложения состоит из следующих модулей:

Модуль ввода графа. Обеспечивает чтение графа из файла или ввода с консоли. Парсит данные в формате: количество вершин, количество рёбер, матрица инцидентности, список весов рёбер. Выполняет проверку корректности формата входных данных.

Модуль валидации графа. Использует функции из модуля graph для проверки корректности графа. Проверяет соответствие графа требованиям: минимальное количество вершин и рёбер, корректность матрицы инцидентности, неотрицательность весов.

Модуль TCP-клиента. Устанавливает TCP-соединение с сервером. Обрабатывает команды пользователя: help, input, load, query, exit. Отправляет запросы серверу и получает ответы. Гарантирует полную отправку и приём данных через TCP-сокет.

Модуль UDP-клиента. Создаёт UDP-сокет для обмена с сервером. Реализует механизм надёжной доставки через подтверждения (ACK). Отправляет запросы с уникальными идентификаторами и ожидает подтверждения от сервера. Выполняет до 3 попыток отправки с таймаутом 3 секунды.

Модуль обработки ответов сервера. Десериализует ответы от сервера и определяет тип команды. Обрабатывает ответы типа Error, Help, PathResult, Ack, UploadGraph. Выводит результаты пользователю в читаемом формате.

Модуль сериализации запросов. Использует функции из модуля protocol для преобразования данных в бинарный формат протокола. Формирует заголовки сообщений и полезные нагрузки для команд UploadGraph и PathQuery.

\subsection{Серверная часть}

Серверная часть приложения состоит из следующих модулей:

Модуль TCP-сервера. Создаёт TCP-сокет, привязывает его к порту и начинает прослушивание входящих соединений. Для каждого подключённого клиента создаёт отдельный поток обработки. Обеспечивает параллельную обработку запросов от нескольких клиентов.

Модуль UDP-сервера. Создаёт UDP-сокет и привязывает его к порту. Обрабатывает входящие датаграммы от клиентов. Хранит состояние графа для каждого клиента в хеш-таблице, используя адрес клиента в качестве ключа. Отправляет подтверждения (ACK) для каждого полученного пакета.

Модуль обработки запросов клиентов. Обрабатывает команды от клиентов: Help, UploadGraph, PathQuery, Exit. Для команды UploadGraph десериализует граф, выполняет валидацию и сохраняет граф в контексте клиента. Для команды PathQuery выполняет поиск кратчайшего пути и формирует ответ.

Модуль вычисления кратчайших путей. Использует функции из модуля graph для поиска кратчайшего пути алгоритмом Беллмана-Форда. Обрабатывает результаты вычисления и формирует ответы для клиентов.

Модуль формирования ответов. Создаёт ответные сообщения для клиентов. Формирует полезные нагрузки для различных типов ответов: результаты поиска пути, сообщения об ошибках, текстовые сообщения.

\subsection{Общие модули}

Модуль протокола (protocol.cpp, protocol.hpp). Реализует функции сериализации и десериализации данных для обмена между клиентом и сервером. Преобразует структуры данных в бинарный формат с использованием сетевого порядка байтов (big endian). Обеспечивает упаковку и распаковку матрицы инцидентности в битовый формат для компактной передачи.

Модуль работы с графами (graph.cpp, graph.hpp). Реализует структуры данных для представления графов и результаты вычислений. Выполняет валидацию графов: проверка минимального количества вершин и рёбер, корректности матрицы инцидентности, неотрицательности весов. Реализует алгоритм Беллмана-Форда для поиска кратчайшего пути в неориентированном графе.

\section{Форматы структур данных, передаваемых между клиентской и серверной частями}

Все сообщения между клиентом и сервером используют единый формат с фиксированным заголовком и переменной полезной нагрузкой.

\subsection{Заголовок сообщения (MessageHeader)}

Заголовок имеет фиксированный размер 12 байт и содержит следующие поля:

command (1 байт) - код команды. Возможные значения: Help (1), UploadGraph (2), PathQuery (3), PathResult (4), Error (5), Ack (6), Exit (7).

status (1 байт) - статус выполнения команды. Возможные значения: Ok (0), InvalidRequest (1), InternalError (2), NotReady (3).

requestId (2 байта) - идентификатор запроса. Используется для UDP-протокола для связывания запроса и ответа. Передаётся в сетевом порядке байтов.

payloadSize (4 байта) - размер полезной нагрузки в байтах. Передаётся в сетевом порядке байтов.

reserved (4 байта) - зарезервированное поле для будущего использования. Передаётся в сетевом порядке байтов.

Все числовые поля заголовка передаются в сетевом порядке байтов (big endian).

\subsection{Полезная нагрузка команды UploadGraph}

Полезная нагрузка команды UploadGraph содержит следующие данные:

vertexCount (2 байта) - количество вершин в графе. Передаётся в сетевом порядке байтов.

edgeCount (2 байта) - количество рёбер в графе. Передаётся в сетевом порядке байтов.

размер битового массива (4 байта) - размер массива байтов, содержащего упакованную матрицу инцидентности. Передаётся в сетевом порядке байтов.

битовый массив матрицы инцидентности (переменный размер) - матрица инцидентности, упакованная в битовый формат. Каждый элемент матрицы кодируется одним битом: 1 означает наличие связи вершины с ребром, 0 означает отсутствие связи. Элементы упаковываются построчно: сначала все рёбра для первой вершины, затем для второй и так далее.

количество весов (4 байта) - количество весов рёбер. Должно совпадать с edgeCount. Передаётся в сетевом порядке байтов.

список весов (4 байта на каждое ребро) - последовательность весов рёбер. Каждый вес передаётся как 32-битное беззнаковое целое число в сетевом порядке байтов.

\subsection{Полезная нагрузка команды PathQuery}

Полезная нагрузка команды PathQuery содержит следующие данные:

source (2 байта) - номер начальной вершины. Нумерация вершин начинается с 0. Передаётся в сетевом порядке байтов.

target (2 байта) - номер конечной вершины. Нумерация вершин начинается с 0. Передаётся в сетевом порядке байтов.

Общий размер полезной нагрузки команды PathQuery составляет 4 байта.

\subsection{Полезная нагрузка команды PathResult}

Полезная нагрузка команды PathResult содержит следующие данные:

distance (4 байта) - длина найденного кратчайшего пути. Передаётся как 32-битное беззнаковое целое число в сетевом порядке байтов.

длина пути (2 байта) - количество вершин в пути. Передаётся в сетевом порядке байтов.

последовательность вершин (2 байта на каждую вершину) - список номеров вершин, образующих кратчайший путь от source до target. Каждая вершина передаётся как 16-битное беззнаковое целое число в сетевом порядке байтов.

\subsection{Полезная нагрузка для текстовых сообщений}

Полезная нагрузка для команд Help и Error, а также для текстовых ответов содержит следующие данные:

длина строки (2 байта) - количество байтов в строке. Передаётся в сетевом порядке байтов.

байты строки (переменный размер) - последовательность байтов, представляющих текст сообщения в кодировке UTF-8.

\subsection{Полезная нагрузка команды Ack}

Полезная нагрузка команды Ack (подтверждение для UDP) пустая. Команда используется только для подтверждения получения сообщения, идентификатор запроса передаётся в заголовке.

\subsection{Полезная нагрузка команды Exit}

Полезная нагрузка команды Exit может быть пустой или содержать текстовое сообщение в формате, описанном выше для текстовых сообщений.

